C51 COMPILER V7.08   MAIN                                                                  04/13/2006 17:21:21 PAGE 1   


C51 COMPILER V7.08, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN main.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE main.c BROWSE DEBUG OBJECTEXTEND

line level    source

   1          #include <string.h>
   2          #include <reg52.h>
   3          #include <intrins.h>
   4          
   5          #define         INT8U           unsigned char 
   6          #define         INT16U          unsigned int
   7          
   8          #define         FOSC            11059200        
   9          #define         BAUD            9600
  10          #define         TIMER1          0XFD    //256-(110592/(12*32*96))
  11          #define         TIMER0H         (65535-3*FOSC/12/1000)/256
  12          #define         TIMER0L         (65535-3*FOSC/12/1000)%256                      //定时3MSVR
  13          //--------------------------------------------------------------------------------------------------------
             ---
  14          //内部寄存器定义
  15          //--------------------------------------------------------------------------------------------------------
             ---
  16          sfr     P4              =       0xc0;   
  17          sfr     ADC_CONTR       =       0xC5;
  18          sfr     AUXR            =       0x8E;
  19          sfr     ADC_DATA        =       0xC6;
  20          sfr     P1_ADC_EN       =       0x97;
  21          //定义I/O口
  22          sbit    POW_UP  =       P3^5;
  23          sbit    CE      =       P3^4;
  24          sbit    DR2     =       P3^3;
  25          sbit    SCK2    =       P3^2;
  26          sbit    MOSI    =       P4^3;
  27          sbit    MISO    =       P1^7;
  28          sbit    SCK     =       P1^6;
  29          sbit    DOUT2   =       P1^5;
  30          sbit    CS      =       P1^4;
  31          sbit    DR1     =       P4^2;
  32          sbit    LED1    =       P4^1;
  33          sbit    LED2    =       P4^0;
  34          
  35          
  36          
  37          
  38          
  39          /********************* I/O define end*****************************************************/
  40          
  41          
  42          #define         FRESELE         0x28            //频道选择
  43          #define         DATANUM         4               //有效数据位数
  44          
  45          #define time0h (65535-3000)/256
  46          #define time0l (65535-3000)%256                 //定时3MS
  47          
  48          
  49          
  50          
  51          code INT8U CofigBuf[15]=
  52                          {
  53                          0x00,                           //接收频道二有效数据长度
C51 COMPILER V7.08   MAIN                                                                  04/13/2006 17:21:21 PAGE 2   

  54                          
  55                          40,                             //接收频道一有效数据长度
  56                          
  57                          0x00,0x00,0x00,0x00,0x00,       //接收频道二地址
  58                          
  59                          0x00,0xcd,0xef,0x12,0xaa,       //接收频道一地址
  60                          
  61                          0x83,                           //32位地址，16位CRC，使能CRC
  62                                                          //bit7~2:ADDR_W,最大40位
  63                                                          
  64                                                          //bit1:CRC_L
  65                                                          //Logic 0: 8 bit CRC    
  66                                                          //Logic 1: 16 bit CRC
  67                                                          
  68                                                          
  69                                                          //BIT0:CRC_EN
  70                                                          //Logic 0: On-chip CRC generation/checking disabled
  71                                                          //Logic 1: On-chip CRC generation/checking enabled
  72                                                          
  73                                                          
  74                          0x4f,                           //ShockBurst模式，250 kbps，16M晶振，0dBm最大功率
  75                          
  76                                                          //Bit 15:RX2_EN
  77                                                          //Logic 0: One channel receive
  78                                                          //Logic 1: Two channels receive
  79                                                          
  80                                                          //Bit 14:
  81                                                          //Communication Mode:
  82                                                          //Logic 0: nRF2401 operates in direct mode.
  83                                                          //Logic 1: nRF2401 operates in ShockBurst. mode
  84          
  85                                                          //Bit 13:
  86                                                          //RF Data Rate:
  87                                                          //Logic 0: 250 kbps
  88                                                          //Logic 1: 1 Mbps
  89                                                          
  90                                                          //Bit 12-10:Selects the nRF2401 crystal frequency to be used:
  91                                                          //      D12     D11     D10     Crystal Frequency [MHz]
  92                                                          //      0       0       0               4
  93                                                          //      0       0       1               8
  94                                                          //      0       1       0               12
  95                                                          //      0       1       1               16
  96                                                          //      1       0       0               20
  97                                                          
  98                                                          //Bit 9-8:RF_PWR: Sets nRF2401 RF output power in transmit mode:
  99                                                          //      D9      D8      P [dBm]
 100                                                          //      0       0       -20
 101                                                          //      0       1       -10
 102                                                          //      1       0       -5
 103                                                          //      1       1       0
 104                                                          
 105                                                          
 106                                                          
 107                          0x50                    //2400+4*1=2404MHZ=2.404G,发送模式
 108                          
 109                                                          //Bit 7 C 1:RF_CH#: Sets the frequency channel the nRF2401 operates on.
 110                                                          //Channelrf = 2400MHZ + RF_CH# * 1.0MHZ
 111                                                          
 112                                                          //Bit 0:Set active mode:
 113                                                          //Logic 0: transmit mode
 114                                                          //Logic 1: receive mode
 115                          };
C51 COMPILER V7.08   MAIN                                                                  04/13/2006 17:21:21 PAGE 3   

 116                          
 117                          
 118          INT8U AddrCofig[4]={0xcd, 0xef, 0x12, 0xaa};                            //地址
 119          INT8U TxBuf[8]={0x40, 0x22, 0x66, 0x88, 0x40, 0x00, 0x00, 0x00};        //发送绶冲区
 120          INT8U RxBuf[8]={0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};        //接收绶冲区                                                    
 121          INT16U timer[2];                                                                //超时计数器
 122          
 123          
 124                          
 125          /*****************************************************************************************
 126          //函数名：void Delay100us(INT8U s)
 127          //输入：时间
 128          //输出：无
 129          //功能描述：廷时
 130          /*****************************************************************************************/
 131          void Delay100us(INT8U n)
 132          {
 133   1              INT8U i;
 134   1              while(n--)
 135   1              {
 136   2                      for(i=0; i<35; i++);
 137   2              }
 138   1      }
 139          /*****************************************************************************************
 140          //函数名：delay(unsigned int s)
 141          //输入：时间
 142          //输出：无
 143          //功能描述：普通廷时
 144          /*****************************************************************************************/             
 145          delay(unsigned int s)
 146          {
 147   1              unsigned int i;
 148   1              for(i=0; i<s; i++);
 149   1              for(i=0; i<s; i++);
 150   1      }
 151          /*****************************************************************************************
 152          //函数名void CpuInit(void)
 153          //输入：无
 154          //输出：无
 155          //功能描述：SPI初始化程序
 156          /*****************************************************************************************/
 157          void CpuInit(void)
 158          {
 159   1              POW_UP = 1;
 160   1              Delay100us(40);
 161   1              CE = 0;
 162   1              CS = 0;
 163   1              SCK = 0;
 164   1      }
 165          
 166          
 167          /*****************************************************************************************
 168          //函数名:UartInit()
 169          //输入：无
 170          //输出：无
 171          //功能描述：串口初始化程序
 172          /*****************************************************************************************/
 173          void UartInit(void)
 174          {
 175   1              SCON = 0x50;            //串口方式1，允许接收
 176   1              TMOD = 0x21;            //定时器1工作方式2，定时器0工作方式1
 177   1              TH1 = TIMER1;   
C51 COMPILER V7.08   MAIN                                                                  04/13/2006 17:21:21 PAGE 4   

 178   1              TL1 = TIMER1;   
 179   1              TR1 = 1;                //启动定时器1
 180   1      }
 181          
 182          
 183          /*****************************************************************************************
 184          //函数名:void TimerInit(void)
 185          //输入：无
 186          //输出：无
 187          //功能描述：定时器0初始化程序
 188          /*****************************************************************************************/
 189          void TimerInit(void)
 190          {
 191   1              TH0 = TIMER0H;
 192   1              TL0 = TIMER0L;
 193   1              ET0 = 1;                        //定时器0中断允许
 194   1              TF0 = 0;
 195   1              TR0 = 1;                        //启动定时器0
 196   1              EA = 1;                         //开全局中断
 197   1      }
 198          
 199          
 200          
 201                  
 202          
 203          /*****************************************************************************************
 204          //函数名：ResetTimer(INT8U n)
 205          //输入：要复位的计时器
 206          //输出：无
 207          //功能描述：复位计时器
 208          /*****************************************************************************************/
 209          void ResetTimer(INT8U n)
 210          {
 211   1              ET0 = 0;                                    // Disable Timer0 interrupt
 212   1              timer[n & 0x01] = 0;                        // Clear timer[n]
 213   1              ET0 = 1;                                    // Enable Timer0 interrupt
 214   1      }
 215          
 216          
 217          /*****************************************************************************************
 218          //函数名：INT16U ReadTimer(INT8U n)
 219          //输入：要读的计时器
 220          //输出：读出值
 221          //功能描述：读计时器
 222          /*****************************************************************************************/
 223          INT16U ReadTimer(INT8U n)
 224          {
 225   1              INT16U tmp;
 226   1              ET0 = 0;                                    // Disable Timer0 interrupt
 227   1              tmp = timer[n];                             // Clear timer[n]
 228   1              ET0 = 1;                                    // Enable Timer0 interrupt
 229   1              return tmp;
 230   1      }
 231          
 232          /*****************************************************************************************
 233          //函数名:SendCh(ch)
 234          //输入：无
 235          //输出：无
 236          //功能描述：串口发送一个字符
 237          /*****************************************************************************************/
 238          void SendCh(INT8U ch)
 239          {
C51 COMPILER V7.08   MAIN                                                                  04/13/2006 17:21:21 PAGE 5   

 240   1              SBUF = ch;
 241   1              while(!TI);
 242   1              TI = 0;
 243   1      }
 244          
 245          
 246          /*****************************************************************************************
 247          //函数名：void SendStr(INT8U *arr)
 248          //输入：发送的字符串
 249          //输出：无
 250          //功能描述：发送一个字符串
 251          /*****************************************************************************************/
 252          void SendStr(INT8U *arr)
 253          {
 254   1              INT8U i;
 255   1              
 256   1              i = 0;
 257   1              while(arr[i] != '\0')
 258   1              {
 259   2                      SendCh(arr[i]);
 260   2                      i++;
 261   2              }
 262   1      }
 263          
 264          /*****************************************************************************************
 265          //函数名：void SpiWriteByte(INT8U dat)
 266          //输入：发送的数据
 267          //输出：无
 268          //功能描述：SPI发送一个字节
 269          /*****************************************************************************************/
 270          void SpiWriteByte(INT8U dat)
 271          {
 272   1              INT8U i;
 273   1      
 274   1              SCK = 0;
 275   1              _nop_();
 276   1              _nop_();
 277   1              for(i=0; i<8; i++)
 278   1              {
 279   2                      if((dat & 0x80) == 0x80)
 280   2                      {
 281   3                              MOSI = 1;
 282   3                              MISO = 1;
 283   3                      }
 284   2                      else 
 285   2                      {
 286   3                              MOSI = 0;
 287   3                              MISO = 0;
 288   3                      }
 289   2                      SCK = 1; 
 290   2                      _nop_();
 291   2                      _nop_();
 292   2                      dat <<= 1;
 293   2                      SCK = 0;
 294   2                      _nop_();
 295   2                      _nop_();
 296   2              }
 297   1      }
 298          
 299          
 300          /*****************************************************************************************
 301          //函数名：INT8U SpiReadByte(void)
C51 COMPILER V7.08   MAIN                                                                  04/13/2006 17:21:21 PAGE 6   

 302          //输入：无
 303          //输出：读出的数据
 304          //功能描述：SPI读出一个字节
 305          /*****************************************************************************************/
 306          INT8U SpiReadByte(void)
 307          {
 308   1              INT8U i,temp;
 309   1              temp = 0;
 310   1              MOSI = 1;
 311   1              MISO = 1;       
 312   1      
 313   1              SCK = 0;
 314   1              _nop_();
 315   1              _nop_();
 316   1              for(i=0; i<8; i++)
 317   1              {
 318   2                      temp <<= 1;
 319   2                      SCK = 1;
 320   2                      _nop_();
 321   2                      _nop_();
 322   2                      if(MISO)temp++; 
 323   2                      SCK = 0;
 324   2                      _nop_();
 325   2                      _nop_();
 326   2              }
 327   1              return temp;
 328   1      }
 329          
 330          
 331          /*****************************************************************************************
 332          //函数名：SetTxMode()
 333          //输入：无
 334          //输出：无
 335          //功能描述：转为发送模式
 336          /*****************************************************************************************/
 337          void SetTxMode(void)
 338          {
 339   1              unsigned char ch;
 340   1              CS = 1;
 341   1              Delay100us(0);
 342   1              ch = FRESELE<<1;
 343   1              SpiWriteByte(ch);
 344   1              CS = 0;
 345   1              Delay100us(2);
 346   1      }
 347          
 348          /*****************************************************************************************
 349          //函数名：SetRxMode()
 350          //输入：无
 351          //输出：无
 352          //功能描述：转为接收模式
 353          /*****************************************************************************************/
 354          void SetRxMode(void)
 355          {
 356   1              unsigned char ch;
 357   1              CS = 1;
 358   1              Delay100us(0);
 359   1              ch = FRESELE<<1;
 360   1              SpiWriteByte(ch | 0x01);
 361   1              CS = 0;
 362   1              Delay100us(2);                          //200us
 363   1      }
C51 COMPILER V7.08   MAIN                                                                  04/13/2006 17:21:21 PAGE 7   

 364          
 365          
 366          
 367          /*****************************************************************************************
 368          //函数名：Nrf2401Init()
 369          //输入：地址,发送数据位数
 370          //输出：无
 371          //功能描述：Nrf2401Init初始化，这里我们配置成32位地址。
 372          /*****************************************************************************************/
 373          void Nrf2401Init(void)
 374          {
 375   1              INT8U i;
 376   1      
 377   1              CE = 0;
 378   1              CS = 1;
 379   1              
 380   1              Delay100us(0);
 381   1              for(i=0; i<15; i++)
 382   1              {
 383   2                      SpiWriteByte(CofigBuf[i]);
 384   2              }
 385   1              CS = 0;
 386   1              
 387   1              Delay100us(30);
 388   1      
 389   1      }
 390          
 391          
 392          /*****************************************************************************************
 393          //函数名：TranData()
 394          //输入：无
 395          //输出：无
 396          //功能描述：发送发送缓冲区的数据。
 397          /*****************************************************************************************/
 398          void TranData(void)
 399          
 400          {
 401   1              INT8U i;
 402   1              
 403   1              SetTxMode();
 404   1              
 405   1              CE = 1;
 406   1              
 407   1              Delay100us(1);
 408   1              
 409   1              for(i=0; i<4; i++)
 410   1              {
 411   2                      SpiWriteByte(AddrCofig[i]);     //发送地址
 412   2              }
 413   1              for(i=0; i<5; i++)
 414   1              {
 415   2                      SpiWriteByte(TxBuf[i]);         //发送五位
 416   2              }
 417   1              
 418   1      
 419   1              CE = 0;
 420   1              
 421   1              Delay100us(13);
 422   1      }
 423          
 424          
 425          
C51 COMPILER V7.08   MAIN                                                                  04/13/2006 17:21:21 PAGE 8   

 426          /*****************************************************************************************
 427          //函数名：void ReceiveBytes(void)
 428          //输入：无
 429          //输出：无
 430          //功能描述：接收数据存在接收缓冲区内
 431          /*****************************************************************************************/
 432          INT8U ReceivePacket(void)
 433          {
 434   1              INT8U i;
 435   1              SetRxMode();
 436   1              CE = 1;    
 437   1              ResetTimer(1);
 438   1              while(DR1 == 0);
 439   1              {
 440   2                      if (ReadTimer(1) > 200)
 441   2                      {
 442   3                              CE = 0;
 443   3                              return 0;
 444   3                      }
 445   2              }
 446   1              i = 0;
 447   1              while(DR1)
 448   1              {
 449   2                      RxBuf[i] = SpiReadByte();
 450   2                      i++;
 451   2                      if (i == 4)
 452   2                      break;
 453   2              }
 454   1              while(DR1)
 455   1              {
 456   2                      SpiReadByte();
 457   2              }
 458   1              CE = 0;
 459   1              return 1;
 460   1      }
 461          
 462          /******************************************************************************************
 463          *******************************************************************************************
 464          ************************************中断服务程序*******************************************
 465          *******************************************************************************************
 466          ******************************************************************************************/
 467          void Timer0ISR(void) interrupt 1
 468          {
 469   1              EA = 0;
 470   1              TH0+=TIMER0H;
 471   1              TL0+=TIMER0L;
 472   1              timer[0]++;
 473   1              timer[1]++;
 474   1              EA = 1;
 475   1      }
 476          
 477          
 478          
 479          /******************************************************************************************
 480          *******************************************************************************************
 481          ******************************************主程序*******************************************
 482          *******************************************************************************************
 483          ******************************************************************************************/
 484          main()
 485          {
 486   1              CpuInit();
 487   1              UartInit();
C51 COMPILER V7.08   MAIN                                                                  04/13/2006 17:21:21 PAGE 9   

 488   1              TimerInit();
 489   1              LED1=0;
 490   1              LED2=0;
 491   1              delay(20000);
 492   1              LED1=1;
 493   1              LED2=1;
 494   1              Nrf2401Init();
 495   1              delay(500);
 496   1              while(1)
 497   1              {
 498   2                      TranData();                     //发送绶冲区数据。
 499   2                      LED2=0;
 500   2                      delay(5000);
 501   2                      LED2=1;
 502   2                      delay(10000);
 503   2              }
 504   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    511    ----
   CONSTANT SIZE    =     15    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     24       3
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
